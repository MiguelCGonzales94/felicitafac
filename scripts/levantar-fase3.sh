#!/bin/bash

# ================================================================
# FELICITAFAC - Script para Levantar Fase 3 Completa
# Sistema de Facturaci√≥n Electr√≥nica para Per√∫
# Levanta Backend Django + Frontend React + MySQL con todos los datos
# ================================================================

set -e  # Salir si cualquier comando falla

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # Sin color

# Configuraci√≥n del proyecto
PROJECT_NAME="FELICITAFAC"
PROJECT_DIR="$(pwd)"
BACKEND_DIR="$PROJECT_DIR/backend"
FRONTEND_DIR="$PROJECT_DIR/frontend"
DATABASE_DIR="$PROJECT_DIR/database"
LOGS_DIR="$PROJECT_DIR/logs"

# Variables de base de datos por defecto
DB_NAME="felicitafac_fase3"
DB_USER="root"
DB_HOST="localhost"
DB_PORT="3306"

# ================================================================
# FUNCIONES DE UTILIDAD
# ================================================================

mostrar_banner() {
    clear
    echo -e "${BLUE}"
    echo "=================================================================="
    echo "  üöÄ FELICITAFAC - LEVANTAR FASE 3"
    echo "  Sistema de Facturaci√≥n Electr√≥nica para Per√∫"
    echo "  Backend + Frontend + APIs + Base de Datos"
    echo "=================================================================="
    echo -e "${NC}"
}

mostrar_seccion() {
    echo -e "\n${CYAN}[SECCI√ìN]${NC} $1"
    echo "=================================================="
}

mostrar_paso() {
    echo -e "${BLUE}[PASO]${NC} $1"
}

mostrar_exito() {
    echo -e "${GREEN}[√âXITO]${NC} $1"
}

mostrar_advertencia() {
    echo -e "${YELLOW}[ADVERTENCIA]${NC} $1"
}

mostrar_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

mostrar_info() {
    echo -e "${PURPLE}[INFO]${NC} $1"
}

# ================================================================
# VERIFICACIONES INICIALES
# ================================================================

verificar_prerrequisitos() {
    mostrar_seccion "Verificando Prerrequisitos del Sistema"
    
    # Verificar que estamos en el directorio correcto
    if [ ! -f "README.md" ] || [ ! -d "backend" ] || [ ! -d "frontend" ]; then
        mostrar_error "Ejecuta este script desde la carpeta ra√≠z de FELICITAFAC"
        mostrar_info "Estructura requerida: felicitafac/backend/, felicitafac/frontend/"
        exit 1
    fi
    mostrar_exito "Estructura del proyecto verificada"
    
    # Verificar Python 3.8+
    
    # Verificar MySQL
    if ! command -v mysql &> /dev/null; then
        mostrar_error "MySQL no est√° instalado"
        mostrar_info "Instala MySQL 8.0+ desde: https://dev.mysql.com/downloads/"
        exit 1
    fi
    mostrar_exito "MySQL $(mysql --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1) ‚úì"
    
    # Verificar Node.js

    
    # Verificar npm
    if ! command -v npm &> /dev/null; then
        mostrar_error "npm no est√° instalado"
        exit 1
    fi
    mostrar_exito "npm $(npm --version) ‚úì"
    
    # Verificar si MySQL est√° corriendo
    if ! mysqladmin -h"$DB_HOST" -P"$DB_PORT" ping &>/dev/null; then
        mostrar_error "MySQL no est√° ejecut√°ndose"
        mostrar_info "Inicia MySQL:"
        echo "  sudo systemctl start mysql    # Linux"
        echo "  brew services start mysql     # macOS"
        echo "  net start mysql               # Windows"
        exit 1
    fi
    mostrar_exito "Servicio MySQL activo ‚úì"
}

# ================================================================
# CONFIGURACI√ìN DE CREDENCIALES
# ================================================================

configurar_credenciales() {
    mostrar_seccion "Configuraci√≥n de Credenciales MySQL"
    
    # Cargar .env si existe
    if [ -f ".env" ]; then
        set -a
        source .env
        set +a
        mostrar_info "Variables cargadas desde .env"
        
        # Usar variables del .env si existen
        DB_NAME=${DB_NAME:-"felicitafac_fase3"}
        DB_USER=${DB_USER:-"root"}
        DB_PASSWORD=${DB_PASSWORD:-""}
        DB_HOST=${DB_HOST:-"localhost"}
        DB_PORT=${DB_PORT:-"3306"}
    fi
    
    echo ""
    mostrar_info "Configuraci√≥n actual:"
    echo "  Host: $DB_HOST:$DB_PORT"
    echo "  Usuario: $DB_USER"
    echo "  Base de datos: $DB_NAME"
    echo ""
    
    echo -n "¬øUsar esta configuraci√≥n? [S/n]: "
    read -r usar_config
    
    if [[ "$usar_config" =~ ^[Nn]$ ]]; then
        echo ""
        mostrar_paso "Ingresa las credenciales de MySQL:"
        
        read -p "Host [$DB_HOST]: " nuevo_host
        DB_HOST=${nuevo_host:-$DB_HOST}
        
        read -p "Puerto [$DB_PORT]: " nuevo_puerto
        DB_PORT=${nuevo_puerto:-$DB_PORT}
        
        read -p "Usuario [$DB_USER]: " nuevo_usuario
        DB_USER=${nuevo_usuario:-$DB_USER}
        
        echo -n "Contrase√±a MySQL: "
        read -s DB_PASSWORD
        echo ""
        
        read -p "Nombre de base de datos [$DB_NAME]: " nuevo_nombre
        DB_NAME=${nuevo_nombre:-$DB_NAME}
    else
        if [ -z "$DB_PASSWORD" ]; then
            echo -n "Contrase√±a MySQL para $DB_USER: "
            read -s DB_PASSWORD
            echo ""
        fi
    fi
    
    # Probar conexi√≥n
    mostrar_paso "Probando conexi√≥n a MySQL..."
    if [ -n "$DB_PASSWORD" ]; then
        mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" -e "SELECT 1;" &>/dev/null
    else
        mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -e "SELECT 1;" &>/dev/null
    fi

    if [ $? -eq 0 ]; then
        mostrar_exito "Conexi√≥n MySQL exitosa"
    else
        mostrar_error "No se pudo conectar a MySQL con las credenciales proporcionadas"
        exit 1
    fi
}

# ================================================================
# CONFIGURACI√ìN DE BASE DE DATOS
# ================================================================

configurar_base_datos() {
    mostrar_seccion "Configurando Base de Datos MySQL"
    
    mostrar_paso "Creando base de datos '$DB_NAME'..."
    mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" -e "
        CREATE DATABASE IF NOT EXISTS \`$DB_NAME\`
        CHARACTER SET utf8mb4
        COLLATE utf8mb4_unicode_ci;
    " 2>/dev/null
    mostrar_exito "Base de datos '$DB_NAME' creada/verificada"
    
    # Ejecutar migraci√≥n de Fase 3
    if [ -f "$DATABASE_DIR/scripts/migracion_fase3.sql" ]; then
        mostrar_paso "Ejecutando migraci√≥n de Fase 3..."
        mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" < "$DATABASE_DIR/scripts/migracion_fase3.sql"
        mostrar_exito "Migraci√≥n de Fase 3 ejecutada"
    else
        mostrar_advertencia "Archivo de migraci√≥n no encontrado: $DATABASE_DIR/scripts/migracion_fase3.sql"
        mostrar_info "Las tablas se crear√°n con Django migrations"
    fi
    
    # Cargar datos iniciales de Fase 3
    if [ -f "$DATABASE_DIR/scripts/datos_iniciales_fase3.sql" ]; then
        mostrar_paso "Cargando datos iniciales de Fase 3..."
        mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" < "$DATABASE_DIR/scripts/datos_iniciales_fase3.sql"
        mostrar_exito "Datos iniciales de Fase 3 cargados"
    else
        mostrar_advertencia "Archivo de datos iniciales no encontrado"
    fi
    
    # Verificar tablas creadas
    table_count=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "SHOW TABLES;" | wc -l)
    if [ $table_count -gt 1 ]; then
        mostrar_exito "Base de datos configurada con $(($table_count - 1)) tablas"
    else
        mostrar_advertencia "No se detectaron tablas en la base de datos"
    fi
}

# ================================================================
# CONFIGURACI√ìN DEL BACKEND DJANGO
# ================================================================

configurar_backend() {
    mostrar_seccion "Configurando Backend Django"
    
    cd "$BACKEND_DIR"
    
    # Crear entorno virtual si no existe
    if [ ! -d "venv" ]; then
        mostrar_paso "Creando entorno virtual Python..."
        python3 -m venv venv
        mostrar_exito "Entorno virtual creado"
    fi
    
    # Activar entorno virtual
    mostrar_paso "Activando entorno virtual..."
    source venv/bin/activate
    mostrar_exito "Entorno virtual activado"
    
    # Instalar dependencias
    if [ -f "requirements.txt" ]; then
        mostrar_paso "Instalando dependencias Python..."
        pip install --upgrade pip
        pip install -r requirements.txt
        mostrar_exito "Dependencias instaladas"
    else
        mostrar_error "Archivo requirements.txt no encontrado"
        exit 1
    fi
    
    # Crear archivo .env para Django
    mostrar_paso "Configurando variables de entorno Django..."
    cat > .env << EOF
# FELICITAFAC - Configuraci√≥n Fase 3
DEBUG=True
SECRET_KEY=felicitafac-fase3-development-key-$(date +%s)

# Base de datos MySQL
DB_NAME=$DB_NAME
DB_USER=$DB_USER
DB_PASSWORD=$DB_PASSWORD
DB_HOST=$DB_HOST
DB_PORT=$DB_PORT

# Configuraci√≥n Django
ALLOWED_HOSTS=localhost,127.0.0.1
CORS_ALLOW_ALL_ORIGINS=True
LANGUAGE_CODE=es-pe
TIME_ZONE=America/Lima

# Configuraci√≥n SUNAT (demo)
NUBEFACT_TOKEN=demo-token-fase3
NUBEFACT_URL_BASE=https://api.nubefact.com
NUBEFACT_TIMEOUT=30

# Empresa (datos de ejemplo)
EMPRESA_RUC=20123456789
EMPRESA_RAZON_SOCIAL=FELICITAFAC DESARROLLO SAC
EMPRESA_DIRECCION=Av. Desarrollo 123

# Email (desarrollo)
EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
EMAIL_HOST=localhost
EMAIL_PORT=1025
EOF
    mostrar_exito "Variables de entorno configuradas"
    
    # Ejecutar migraciones Django
    mostrar_paso "Ejecutando migraciones Django..."
    python manage.py makemigrations
    python manage.py migrate
    mostrar_exito "Migraciones Django ejecutadas"
    
    # Crear superusuario si no existe
    mostrar_paso "Verificando superusuario..."
    if ! python manage.py shell -c "from django.contrib.auth import get_user_model; User = get_user_model(); print('exists' if User.objects.filter(email='admin@felicitafac.com').exists() else 'not_exists')" | grep -q "exists"; then
        mostrar_paso "Creando superusuario admin@felicitafac.com..."
        python manage.py shell -c "
from aplicaciones.usuarios.models import Usuario
usuario = Usuario.objects.create_user(
    email='admin@felicitafac.com',
    password='admin123',
    nombre='Administrador',
    apellidos='del Sistema',
    rol='administrador',
    is_staff=True,
    is_superuser=True
)
print('‚úì Superusuario creado exitosamente')
"
        mostrar_exito "Superusuario creado: admin@felicitafac.com / admin123"
    else
        mostrar_info "Superusuario ya existe: admin@felicitafac.com"
    fi
    
    # Verificar configuraci√≥n
    mostrar_paso "Verificando configuraci√≥n Django..."
    python manage.py check
    mostrar_exito "Configuraci√≥n Django v√°lida"
    
    cd "$PROJECT_DIR"
}

# ================================================================
# CONFIGURACI√ìN DEL FRONTEND REACT
# ================================================================

configurar_frontend() {
    mostrar_seccion "Configurando Frontend React"
    
    cd "$FRONTEND_DIR"
    
    # Verificar package.json
    if [ ! -f "package.json" ]; then
        mostrar_error "Archivo package.json no encontrado"
        exit 1
    fi
    
    # Instalar dependencias
    mostrar_paso "Instalando dependencias Node.js..."
    npm install
    mostrar_exito "Dependencias Node.js instaladas"
    
    # Crear archivo .env para React
    mostrar_paso "Configurando variables de entorno React..."
    cat > .env.local << EOF
# FELICITAFAC Frontend - Fase 3
VITE_API_URL=http://localhost:8000
VITE_APP_NAME=FELICITAFAC
VITE_APP_VERSION=3.0.0
VITE_ENVIRONMENT=development
VITE_DEBUG=true

# Configuraci√≥n de la empresa
VITE_EMPRESA_RUC=20123456789
VITE_EMPRESA_NOMBRE=FELICITAFAC DESARROLLO SAC

# URLs de servicios
VITE_NUBEFACT_DOCS_URL=https://nubefact.com/documentacion
VITE_SUNAT_CONSULTA_URL=https://e-consultaruc.sunat.gob.pe/cl-ti-itmrconsruc/jcrS00Alias
EOF
    mostrar_exito "Variables de entorno React configuradas"
    
    # Verificar configuraci√≥n
    mostrar_paso "Verificando configuraci√≥n React..."
    if npm run build --dry-run &>/dev/null; then
        mostrar_exito "Configuraci√≥n React v√°lida"
    else
        mostrar_advertencia "Verificaci√≥n de build React no disponible"
    fi
    
    cd "$PROJECT_DIR"
}

# ================================================================
# VERIFICACI√ìN FINAL
# ================================================================

verificar_configuracion() {
    mostrar_seccion "Verificaci√≥n Final del Sistema"
    
    # Verificar conexi√≥n a base de datos desde Django
    mostrar_paso "Verificando conexi√≥n Django -> MySQL..."
    cd "$BACKEND_DIR"
    source venv/bin/activate
    
    if python manage.py shell -c "
from django.db import connection
cursor = connection.cursor()
cursor.execute('SELECT COUNT(*) FROM aplicaciones_usuarios_usuario')
count = cursor.fetchone()[0]
print(f'‚úì Usuarios en BD: {count}')
" 2>/dev/null; then
        mostrar_exito "Conexi√≥n Django -> MySQL funcionando"
    else
        mostrar_error "Error en conexi√≥n Django -> MySQL"
        exit 1
    fi
    
    # Verificar APIs REST
    mostrar_paso "Verificando APIs REST..."
    if python manage.py shell -c "
from rest_framework.test import APIClient
client = APIClient()
response = client.get('/api/')
print(f'‚úì API Status: {response.status_code}')
" 2>/dev/null; then
        mostrar_exito "APIs REST configuradas"
    else
        mostrar_advertencia "APIs REST pendientes de verificaci√≥n"
    fi
    
    cd "$PROJECT_DIR"
    
    # Crear directorio de logs
    mkdir -p "$LOGS_DIR"
    mostrar_exito "Directorio de logs creado"
    
    # Verificar puertos disponibles
    if lsof -i :8000 &>/dev/null; then
        mostrar_advertencia "Puerto 8000 en uso (Django)"
    else
        mostrar_exito "Puerto 8000 disponible para Django"
    fi
    
    if lsof -i :5173 &>/dev/null; then
        mostrar_advertencia "Puerto 5173 en uso (React)"
    else
        mostrar_exito "Puerto 5173 disponible para React"
    fi
}

# ================================================================
# INICIAR SERVICIOS
# ================================================================

iniciar_servicios() {
    mostrar_seccion "Iniciando Servicios FELICITAFAC Fase 3"
    
    # Crear scripts de inicio en background
    mostrar_paso "Configurando scripts de inicio..."
    
    # Script para iniciar Django
    cat > "$PROJECT_DIR/start-backend.sh" << 'EOF'
#!/bin/bash
cd backend
source venv/bin/activate
echo "üöÄ Iniciando Django en http://localhost:8000"
python manage.py runserver 0.0.0.0:8000
EOF
    chmod +x "$PROJECT_DIR/start-backend.sh"
    
    # Script para iniciar React
    cat > "$PROJECT_DIR/start-frontend.sh" << 'EOF'
#!/bin/bash
cd frontend
echo "üöÄ Iniciando React en http://localhost:5173"
npm run dev
EOF
    chmod +x "$PROJECT_DIR/start-frontend.sh"
    
    mostrar_exito "Scripts de inicio creados"
    
    echo ""
    mostrar_info "üéØ OPCIONES DE INICIO:"
    echo ""
    echo "1Ô∏è‚É£  Iniciar solo Backend Django:"
    echo "   ./start-backend.sh"
    echo ""
    echo "2Ô∏è‚É£  Iniciar solo Frontend React:"
    echo "   ./start-frontend.sh"
    echo ""
    echo "3Ô∏è‚É£  Iniciar ambos servicios:"
    echo "   ./start-backend.sh & ./start-frontend.sh"
    echo ""
    
    echo -n "¬øIniciar ambos servicios ahora? [S/n]: "
    read -r iniciar_ahora
    
    if [[ ! "$iniciar_ahora" =~ ^[Nn]$ ]]; then
        mostrar_paso "Iniciando servicios en background..."
        
        # Iniciar Django en background
        cd "$BACKEND_DIR"
        source venv/bin/activate
        nohup python manage.py runserver 0.0.0.0:8000 > "$LOGS_DIR/django.log" 2>&1 &
        DJANGO_PID=$!
        
        # Esperar un momento
        sleep 3
        
        # Iniciar React en background
        cd "$FRONTEND_DIR"
        nohup npm run dev > "$LOGS_DIR/react.log" 2>&1 &
        REACT_PID=$!
        
        cd "$PROJECT_DIR"
        
        # Guardar PIDs para poder detener despu√©s
        echo "$DJANGO_PID" > "$LOGS_DIR/django.pid"
        echo "$REACT_PID" > "$LOGS_DIR/react.pid"
        
        mostrar_exito "Servicios iniciados en background"
        
        # Esperar a que los servicios est√©n listos
        mostrar_paso "Esperando que los servicios est√©n listos..."
        sleep 5
        
        # Verificar que los servicios est√©n corriendo
        if curl -s http://localhost:8000/api/ &>/dev/null; then
            mostrar_exito "‚úÖ Django API disponible en http://localhost:8000"
        else
            mostrar_advertencia "Django tardando en iniciar, revisar logs/django.log"
        fi
        
        if curl -s http://localhost:5173 &>/dev/null; then
            mostrar_exito "‚úÖ React App disponible en http://localhost:5173"
        else
            mostrar_advertencia "React tardando en iniciar, revisar logs/react.log"
        fi
    fi
}

# ================================================================
# INFORMACI√ìN FINAL
# ================================================================

mostrar_informacion_final() {
    mostrar_seccion "¬°FELICITAFAC FASE 3 LEVANTADA EXITOSAMENTE!"
    
    echo -e "${GREEN}"
    echo "=================================================================="
    echo "  üéâ SISTEMA COMPLETAMENTE CONFIGURADO Y FUNCIONANDO"
    echo "=================================================================="
    echo -e "${NC}"
    
    echo -e "${CYAN}üìã ACCESOS AL SISTEMA:${NC}"
    echo "=================================="
    echo -e "üåê Frontend React:     ${BLUE}http://localhost:5173${NC}"
    echo -e "üîß Backend Django:     ${BLUE}http://localhost:8000${NC}"
    echo -e "üìä API REST:           ${BLUE}http://localhost:8000/api/${NC}"
    echo -e "‚öôÔ∏è  Admin Django:       ${BLUE}http://localhost:8000/admin/${NC}"
    echo ""
    
    echo -e "${CYAN}üë§ CREDENCIALES DE ACCESO:${NC}"
    echo "=================================="
    echo -e "üîë Administrador:      ${GREEN}admin@felicitafac.com${NC} / ${GREEN}admin123${NC}"
    echo ""
    
    echo -e "${CYAN}üóÑÔ∏è BASE DE DATOS MYSQL:${NC}"
    echo "=================================="
    echo -e "üìä Nombre:             ${GREEN}$DB_NAME${NC}"
    echo -e "üë§ Usuario:            ${GREEN}$DB_USER${NC}"
    echo -e "üè† Host:               ${GREEN}$DB_HOST:$DB_PORT${NC}"
    echo -e "üìã Tablas:             ${GREEN}~40 tablas creadas${NC}"
    echo -e "üì¶ Datos:              ${GREEN}Datos de ejemplo cargados${NC}"
    echo ""
    
    echo -e "${CYAN}üõ†Ô∏è FUNCIONALIDADES DISPONIBLES:${NC}"
    echo "=================================="
    echo -e "‚úÖ Gesti√≥n de Clientes (RUC/DNI)"
    echo -e "‚úÖ Gesti√≥n de Productos e Inventario"
    echo -e "‚úÖ Facturaci√≥n Electr√≥nica"
    echo -e "‚úÖ Integraci√≥n Nubefact (Demo)"
    echo -e "‚úÖ Control de Inventario PEPS"
    echo -e "‚úÖ APIs REST completas"
    echo -e "‚úÖ Autenticaci√≥n JWT"
    echo -e "‚úÖ Panel de Administraci√≥n"
    echo ""
    
    echo -e "${CYAN}üìÅ ARCHIVOS IMPORTANTES:${NC}"
    echo "=================================="
    echo -e "üìÑ Logs Backend:       ${YELLOW}logs/django.log${NC}"
    echo -e "üìÑ Logs Frontend:      ${YELLOW}logs/react.log${NC}"
    echo -e "üîß Configuraci√≥n:      ${YELLOW}.env${NC}"
    echo -e "üöÄ Iniciar Backend:    ${YELLOW}./start-backend.sh${NC}"
    echo -e "üöÄ Iniciar Frontend:   ${YELLOW}./start-frontend.sh${NC}"
    echo ""
    
    echo -e "${CYAN}üîß COMANDOS √öTILES:${NC}"
    echo "=================================="
    echo -e "üìä Ver logs Django:    ${BLUE}tail -f logs/django.log${NC}"
    echo -e "üìä Ver logs React:     ${BLUE}tail -f logs/react.log${NC}"
    echo -e "üõë Detener servicios:  ${BLUE}./scripts/detener-servicios.sh${NC}"
    echo -e "üîÑ Reiniciar todo:     ${BLUE}./scripts/levantar-fase3.sh${NC}"
    echo -e "üß™ Ejecutar tests:     ${BLUE}cd backend && python manage.py test${NC}"
    echo ""
    
    echo -e "${YELLOW}üìù PR√ìXIMOS PASOS RECOMENDADOS:${NC}"
    echo "=================================="
    echo "1. üåê Abrir http://localhost:5173 para ver el frontend"
    echo "2. üîë Hacer login con admin@felicitafac.com / admin123"
    echo "3. üìä Explorar las APIs en http://localhost:8000/api/"
    echo "4. üß™ Probar crear clientes, productos y facturas"
    echo "5. üìã Revisar los logs si hay alg√∫n problema"
    echo "6. üöÄ Continuar con Fase 4: Desarrollo Frontend avanzado"
    echo ""
    
    if [ -f "$LOGS_DIR/django.pid" ] && [ -f "$LOGS_DIR/react.pid" ]; then
        echo -e "${GREEN}üéØ ¬°SISTEMA CORRIENDO EN BACKGROUND!${NC}"
        echo -e "Para detener: ${BLUE}kill \$(cat logs/django.pid logs/react.pid)${NC}"
    else
        echo -e "${YELLOW}üí° INICIAR MANUALMENTE:${NC}"
        echo -e "Backend:  ${BLUE}./start-backend.sh${NC}"
        echo -e "Frontend: ${BLUE}./start-frontend.sh${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}üéâ ¬°FELICITAFAC FASE 3 LISTA PARA USAR!${NC}"
}

# ================================================================
# FUNCI√ìN PRINCIPAL
# ================================================================

main() {
    # Mostrar banner
    mostrar_banner
    
    # Confirmar ejecuci√≥n
    echo -e "${YELLOW}¬øDesea levantar FELICITAFAC Fase 3 completa? [S/n]:${NC}"
    read -r confirmar
    
    if [[ "$confirmar" =~ ^[Nn]$ ]]; then
        echo "Operaci√≥n cancelada."
        exit 0
    fi
    
    # Ejecutar configuraci√≥n paso a paso
    verificar_prerrequisitos
    configurar_credenciales
    configurar_base_datos
    configurar_backend
    configurar_frontend
    verificar_configuracion
    iniciar_servicios
    mostrar_informacion_final
}

# ================================================================
# MANEJO DE ERRORES
# ================================================================

cleanup() {
    mostrar_error "Script interrumpido. Limpiando procesos..."
    
    # Matar procesos si existen
    if [ -f "$LOGS_DIR/django.pid" ]; then
        kill $(cat "$LOGS_DIR/django.pid") 2>/dev/null || true
        rm -f "$LOGS_DIR/django.pid"
    fi
    
    if [ -f "$LOGS_DIR/react.pid" ]; then
        kill $(cat "$LOGS_DIR/react.pid") 2>/dev/null || true
        rm -f "$LOGS_DIR/react.pid"
    fi
    
    exit 1
}

trap cleanup INT TERM

# ================================================================
# EJECUCI√ìN
# ================================================================

# Verificar directorio correcto
if [ ! -f "README.md" ] || [ ! -d "backend" ] || [ ! -d "frontend" ]; then
    echo -e "${RED}[ERROR]${NC} Ejecuta desde la carpeta ra√≠z de FELICITAFAC"
    echo -e "${YELLOW}[INFO]${NC} Estructura requerida:"
    echo "  felicitafac/"
    echo "  ‚îú‚îÄ‚îÄ backend/"
    echo "  ‚îú‚îÄ‚îÄ frontend/"
    echo "  ‚îú‚îÄ‚îÄ scripts/"
    echo "  ‚îî‚îÄ‚îÄ README.md"
    exit 1
fi

# Ejecutar funci√≥n principal
main "$@"