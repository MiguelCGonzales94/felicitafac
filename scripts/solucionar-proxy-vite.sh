#!/bin/bash

# FELICITAFAC - Script para Solucionar Proxy Vite
# Resuelve problemas de comunicaci√≥n React ‚Üî Django

set -e

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

mostrar_mensaje() {
    echo -e "${BLUE}[FELICITAFAC]${NC} $1"
}

mostrar_exito() {
    echo -e "${GREEN}[√âXITO]${NC} $1"
}

mostrar_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

mostrar_fix() {
    echo -e "${PURPLE}[FIX]${NC} $1"
}

echo ""
echo "üîß FELICITAFAC - Solucionador de Proxy Vite"
echo "============================================"
echo ""

# Verificar directorio
if [ ! -d "frontend" ] || [ ! -f "frontend/vite.config.ts" ]; then
    mostrar_error "Ejecutar desde la carpeta ra√≠z de FELICITAFAC"
    exit 1
fi

mostrar_mensaje "üîç Diagnosticando problema de proxy Vite..."
echo ""

# 1. Verificar que Django est√© funcionando
mostrar_mensaje "‚úÖ Verificando Django..."
if curl -s http://localhost:8000/api/ | grep -q "mensaje"; then
    mostrar_exito "‚úÖ Django funcionando correctamente"
else
    mostrar_error "‚ùå Django no responde. Ejecuta primero: cd backend && python manage.py runserver"
    exit 1
fi

# 2. Crear backup de configuraci√≥n actual
mostrar_fix "üìã Creando backup de configuraci√≥n..."
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
mkdir -p "backups/frontend_$TIMESTAMP"
cp frontend/vite.config.ts "backups/frontend_$TIMESTAMP/"
cp frontend/package.json "backups/frontend_$TIMESTAMP/"

# 3. Actualizar configuraci√≥n de Vite
mostrar_fix "üîß Actualizando configuraci√≥n de Vite..."

cat > frontend/vite.config.ts << 'EOF'
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  server: {
    port: 3000,
    host: true,
    strictPort: true,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        secure: false,
        ws: true,
        configure: (proxy, _options) => {
          proxy.on('error', (err, _req, _res) => {
            console.log('proxy error', err);
          });
          proxy.on('proxyReq', (proxyReq, req, _res) => {
            console.log('Sending Request to the Target:', req.method, req.url);
          });
          proxy.on('proxyRes', (proxyRes, req, _res) => {
            console.log('Received Response from the Target:', proxyRes.statusCode, req.url);
          });
        },
      },
      '/admin': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        secure: false,
      },
      '/health': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        secure: false,
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true,
  },
})
EOF

mostrar_exito "‚úÖ Configuraci√≥n de Vite actualizada"

# 4. Actualizar App.tsx con mejor manejo de errores
mostrar_fix "‚öõÔ∏è Actualizando App.tsx con mejor manejo de errores..."

cat > frontend/src/App.tsx << 'EOF'
import { useState, useEffect } from 'react'

function App() {
  const [backendStatus, setBackendStatus] = useState<string>('Verificando...')
  const [connectionDetails, setConnectionDetails] = useState<string>('')

  useEffect(() => {
    const verificarConexion = async () => {
      try {
        console.log('üîç Intentando conectar a /api/...')
        
        const response = await fetch('/api/', {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
          },
        })
        
        console.log('üì° Respuesta recibida:', {
          status: response.status,
          statusText: response.statusText,
          headers: Object.fromEntries(response.headers.entries())
        })
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }
        
        const contentType = response.headers.get('content-type')
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text()
          throw new Error(`Respuesta no es JSON. Content-Type: ${contentType}. Contenido: ${text.substring(0, 100)}...`)
        }
        
        const data = await response.json()
        console.log('‚úÖ Datos recibidos:', data)
        
        setBackendStatus(`‚úÖ Backend conectado: ${data.mensaje}`)
        setConnectionDetails(`Versi√≥n: ${data.version} | Estado: ${data.estado}`)
        
      } catch (error) {
        console.error('‚ùå Error detallado:', error)
        
        if (error instanceof TypeError && error.message.includes('fetch')) {
          setBackendStatus('‚ùå Error de red: No se puede conectar al backend')
          setConnectionDetails('Verifica que Django est√© ejecut√°ndose en puerto 8000')
        } else if (error instanceof SyntaxError) {
          setBackendStatus('‚ùå Error de JSON: Respuesta no v√°lida del servidor')
          setConnectionDetails('El servidor no est√° devolviendo JSON v√°lido')
        } else {
          setBackendStatus(`‚ùå Error: ${error.message}`)
          setConnectionDetails('Revisa la consola del navegador para m√°s detalles')
        }
      }
    }
    
    verificarConexion()
    
    // Reintentar cada 30 segundos si hay error
    const interval = setInterval(() => {
      if (backendStatus.includes('‚ùå')) {
        verificarConexion()
      }
    }, 30000)
    
    return () => clearInterval(interval)
  }, [backendStatus])

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-2">
            üßæ FELICITAFAC
          </h1>
          <p className="text-gray-600">
            Sistema de Facturaci√≥n Electr√≥nica para Per√∫
          </p>
        </div>
        
        <div className="mb-6 p-4 bg-gray-50 rounded-lg">
          <h2 className="font-semibold text-gray-700 mb-2">Estado del Sistema</h2>
          <p className={`text-sm mb-2 ${backendStatus.includes('‚úÖ') ? 'text-green-600' : 'text-red-600'}`}>
            {backendStatus}
          </p>
          {connectionDetails && (
            <p className="text-xs text-gray-500 mb-2">{connectionDetails}</p>
          )}
          <p className="text-sm text-green-600">‚úÖ Frontend React funcionando</p>
        </div>

        <div className="space-y-3">
          <div className="p-3 bg-blue-50 rounded-lg">
            <p className="text-sm text-blue-800">
              <strong>Fase 1:</strong> Configuraci√≥n MySQL y Arquitectura Base
            </p>
            <p className="text-xs text-blue-600 mt-1">
              ‚úÖ Backend Django + MySQL configurado
            </p>
          </div>
          
          <div className="p-3 bg-yellow-50 rounded-lg">
            <p className="text-sm text-yellow-800">
              <strong>Pr√≥ximas Fases:</strong>
            </p>
            <p className="text-xs text-yellow-600 mt-1">
              Fase 2: Autenticaci√≥n ‚Ä¢ Fase 3: APIs ‚Ä¢ Fase 4: POS Frontend
            </p>
          </div>
        </div>

        <div className="mt-6 pt-4 border-t border-gray-200">
          <p className="text-xs text-gray-500">
            Acceso Admin: <a href="http://localhost:8000/admin" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">localhost:8000/admin</a>
          </p>
          <p className="text-xs text-gray-500 mt-1">
            API Directa: <a href="http://localhost:8000/api/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">localhost:8000/api/</a>
          </p>
        </div>
        
        {/* Panel de debug */}
        <div className="mt-4 p-3 bg-gray-100 rounded-lg text-left">
          <h3 className="text-xs font-semibold text-gray-700 mb-2">üîß Debug Info</h3>
          <p className="text-xs text-gray-600">Puerto Frontend: 3000</p>
          <p className="text-xs text-gray-600">Proxy: /api ‚Üí localhost:8000</p>
          <p className="text-xs text-gray-600">Timestamp: {new Date().toLocaleString()}</p>
        </div>
      </div>
    </div>
  )
}

export default App
EOF

mostrar_exito "‚úÖ App.tsx actualizado con mejor diagn√≥stico"

# 5. Crear archivo de variables de entorno para Vite
mostrar_fix "üåç Configurando variables de entorno..."

cat > frontend/.env.local << 'EOF'
# FELICITAFAC - Variables de entorno para desarrollo
VITE_API_URL=http://localhost:8000
VITE_ENVIRONMENT=development
VITE_DEBUG=true
EOF

# 6. Reiniciar frontend React
mostrar_fix "üîÑ Reiniciando frontend React..."

# Detener React si est√° ejecut√°ndose
pkill -f "npm.*run.*dev" 2>/dev/null || true
pkill -f "node.*vite" 2>/dev/null || true
sleep 2

cd frontend

# Verificar dependencias
if [ ! -d "node_modules" ]; then
    mostrar_error "Dependencias no instaladas. Ejecutando npm install..."
    npm install
fi

# Limpiar cach√© de Vite
rm -rf dist .vite node_modules/.vite

# Crear directorio de logs
mkdir -p ../logs

# Iniciar React con configuraci√≥n actualizada
echo ""
mostrar_mensaje "üöÄ Iniciando React con configuraci√≥n corregida..."

export VITE_API_URL="http://localhost:8000"
export VITE_ENVIRONMENT="development"

nohup npm run dev -- --port 3000 --host 0.0.0.0 > ../logs/frontend.log 2>&1 &
FRONTEND_PID=$!

echo $FRONTEND_PID > ../logs/frontend.pid

cd ..

# 7. Esperar que React est√© listo
mostrar_mensaje "‚è≥ Esperando que React est√© listo..."

contador=0
while [ $contador -lt 20 ]; do
    if curl -s http://localhost:3000/ > /dev/null 2>&1; then
        mostrar_exito "‚úÖ React iniciado exitosamente"
        break
    fi
    echo -n "."
    sleep 2
    ((contador++))
done

if [ $contador -eq 20 ]; then
    mostrar_error "‚ùå React no respondi√≥ en 40 segundos"
    echo "üìù Revisa logs: tail -f logs/frontend.log"
    exit 1
fi

echo ""

# 8. Verificaci√≥n final del proxy
mostrar_mensaje "üîç VERIFICACI√ìN FINAL DEL PROXY"
echo ""

# Probar desde el proxy de Vite
echo "Probando proxy Vite ‚Üí Django..."
PROXY_TEST=$(curl -s -w "%{http_code}" http://localhost:3000/api/ 2>/dev/null || echo "000")

if echo "$PROXY_TEST" | grep -q "200"; then
    mostrar_exito "‚úÖ Proxy Vite ‚Üí Django funcionando correctamente"
    echo ""
    echo "üéâ ¬°PROBLEMA DEL PROXY RESUELTO!"
    echo ""
    echo "‚úÖ Django: http://localhost:8000/api/ ‚Üí 200 OK"
    echo "‚úÖ Proxy: http://localhost:3000/api/ ‚Üí 200 OK"
    echo "‚úÖ React: http://localhost:3000 ‚Üí Funcionando"
    echo ""
    echo "üåê Abre en el navegador: http://localhost:3000"
    echo "   Deber√≠as ver: ‚úÖ Backend conectado: ¬°Bienvenido a FELICITAFAC API!"
    
else
    mostrar_error "‚ùå El proxy todav√≠a no funciona correctamente"
    echo ""
    echo "üìã DIAGN√ìSTICO MANUAL:"
    echo ""
    echo "1. üîç Verifica logs del frontend:"
    echo "   tail -f logs/frontend.log"
    echo ""
    echo "2. üåê Prueba directamente:"
    echo "   curl http://localhost:8000/api/  # Debe funcionar"
    echo "   curl http://localhost:3000/api/  # Debe funcionar via proxy"
    echo ""
    echo "3. üîß Si persiste, reinicia ambos servicios:"
    echo "   ./scripts/detener-desarrollo.sh"
    echo "   ./scripts/iniciar-desarrollo.sh"
fi

echo ""
echo "üìã CONFIGURACI√ìN ACTUALIZADA:"
echo "============================"
echo "‚úÖ Vite proxy con logs detallados"
echo "‚úÖ App.tsx con mejor manejo de errores"
echo "‚úÖ Variables de entorno configuradas"
echo "‚úÖ Logs de debug habilitados"
echo ""
echo "üìù LOGS √öTILES:"
echo "==============="
echo "Frontend: tail -f logs/frontend.log"
echo "Backend: tail -f logs/backend.log"
echo ""
echo "üîß BACKUPS EN: backups/frontend_$TIMESTAMP/"